# Squid Proxy Configuration - SWG-lite
# OpenSASE-Lab Security PoP
# Basic web gateway without TLS interception

# ============================================
# Network Settings
# ============================================
http_port 3128

# Visible hostname
visible_hostname security-pop.opensase.lab

# ============================================
# Access Control
# ============================================
# Define local networks
acl localnet src 10.200.0.0/24  # PoP network
acl localnet src 10.201.0.0/24  # Branch A
acl localnet src 10.202.0.0/24  # Branch B
acl localnet src 10.203.0.0/24  # Branch C
acl localnet src 10.210.0.0/24  # Ziti fabric

# SSL ports
acl SSL_ports port 443

# Safe ports
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# CONNECT method
acl CONNECT method CONNECT

# ============================================
# Access Rules
# ============================================
# Deny requests to non-safe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost manager
http_access deny manager

# Allow local networks
http_access allow localnet
http_access allow localhost

# Deny all else
http_access deny all

# ============================================
# Basic URL Filtering (Demo blocklist)
# ============================================
# Block known bad domains (for demo purposes)
acl blocked_domains dstdomain .blocked.demo.lab
acl blocked_domains dstdomain .malware-test.lab
acl blocked_domains dstdomain .phishing-demo.lab
http_access deny blocked_domains

# ============================================
# Caching Settings
# ============================================
# Cache directory
cache_dir ufs /var/cache/squid 100 16 256

# Memory cache
cache_mem 64 MB
maximum_object_size_in_memory 512 KB

# Object size limits
maximum_object_size 100 MB
minimum_object_size 0 KB

# Refresh patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# ============================================
# Logging
# ============================================
# Access log format for Wazuh ingestion
logformat opensase %{%Y-%m-%d %H:%M:%S}tl %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt "%{User-Agent}>h"

# Log files
access_log /var/log/squid/access.log opensase
cache_log /var/log/squid/cache.log

# Log rotation (let logrotate handle this)
logfile_rotate 0

# ============================================
# Performance Settings
# ============================================
# Connection limits
max_filedescriptors 4096

# Timeout settings
connect_timeout 30 seconds
read_timeout 5 minutes
request_timeout 5 minutes
client_lifetime 1 day

# Persistent connections
client_persistent_connections on
server_persistent_connections on

# Pipeline settings (for performance)
pipeline_prefetch 10

# ============================================
# Privacy Settings
# ============================================
# Remove identifying headers
via off
forwarded_for delete

# No version in error pages
httpd_suppress_version_string on

# ============================================
# Security Headers
# ============================================
# Add security headers to responses (via)
# Note: No TLS interception - HTTPS sites unaffected
reply_header_access X-Squid-Error deny all
reply_header_access X-Cache deny all
reply_header_access X-Cache-Lookup deny all

# ============================================
# Error Pages
# ============================================
# Custom error page directory (optional)
# error_directory /etc/squid/errors

# Deny info for blocked sites
deny_info ERR_ACCESS_DENIED blocked_domains

# ============================================
# ICAP Integration (Optional - disabled by default)
# ============================================
# Uncomment to enable ICAP for antivirus scanning
# icap_enable on
# icap_service service_avi_req reqmod_precache icap://localhost:1344/avscan bypass=on
# adaptation_access service_avi_req allow all
