# OpenSASE VPP Engine - Setup Configuration
# Executed after VPP startup via startup-config directive
#
# This file configures interfaces, WireGuard tunnels, and routing.
# Replace placeholder keys with actual base64-encoded WireGuard keys.
#
# File: /etc/vpp/setup.conf

# ===============================================================
# MANAGEMENT INTERFACE
# ===============================================================

# Create loopback for management
create loopback interface instance 0
set interface ip address loop0 10.255.255.1/32
set interface state loop0 up

# ===============================================================
# WAN INTERFACE CONFIGURATION
# ===============================================================

# Configure WAN interface (100GbE)
set interface ip address wan0 203.0.113.10/24
set interface state wan0 up
set interface mtu 9000 wan0

# Configure LAN interface (if used)
set interface state lan0 up
set interface mtu 9000 lan0

# ===============================================================
# WIREGUARD TUNNEL CREATION
# ===============================================================

# Create WireGuard tunnel interface
# Replace <BASE64_PRIVATE_KEY> with your private key
wireguard create listen-port 51820 private-key <BASE64_PRIVATE_KEY> src 203.0.113.10

# ===============================================================
# WIREGUARD PEERS - PoP MESH
# ===============================================================

# Add peer: PoP-London
# Replace <LONDON_PUBLIC_KEY> with London PoP public key
wireguard peer add wg0 \
    public-key <LONDON_PUBLIC_KEY> \
    endpoint 198.51.100.10:51820 \
    allowed-ip 10.0.0.0/8 \
    persistent-keepalive 25

# Add peer: PoP-Tokyo
# Replace <TOKYO_PUBLIC_KEY> with Tokyo PoP public key
wireguard peer add wg0 \
    public-key <TOKYO_PUBLIC_KEY> \
    endpoint 192.0.2.10:51820 \
    allowed-ip 10.0.0.0/8 \
    persistent-keepalive 25

# Add peer: PoP-New-York
# wireguard peer add wg0 \
#     public-key <NYC_PUBLIC_KEY> \
#     endpoint 198.51.100.20:51820 \
#     allowed-ip 10.0.0.0/8 \
#     persistent-keepalive 25

# Add peer: PoP-Singapore  
# wireguard peer add wg0 \
#     public-key <SG_PUBLIC_KEY> \
#     endpoint 192.0.2.20:51820 \
#     allowed-ip 10.0.0.0/8 \
#     persistent-keepalive 25

# ===============================================================
# TUNNEL INTERFACE CONFIGURATION
# ===============================================================

# Enable WireGuard tunnel interface
set interface state wg0 up
set interface ip address wg0 10.200.0.1/24

# ===============================================================
# ROUTING VIA TUNNELS
# ===============================================================

# Route to London tenant networks
ip route add 10.1.0.0/16 via 10.200.0.2

# Route to Tokyo tenant networks  
ip route add 10.2.0.0/16 via 10.200.0.3

# Route to NYC tenant networks
# ip route add 10.3.0.0/16 via 10.200.0.4

# Route to Singapore tenant networks
# ip route add 10.4.0.0/16 via 10.200.0.5

# ===============================================================
# OPENSASE FEATURE ACTIVATION
# ===============================================================

# Enable OpenSASE SASE pipeline on WAN interface
set interface feature wan0 ip4-unicast opensase-tenant

# Enable on LAN interface for inbound traffic
set interface feature lan0 ip4-unicast opensase-tenant

# ===============================================================
# TENANT CONFIGURATION
# ===============================================================

# Map source IP prefixes to tenant IDs
# opensase tenant add 10.1.0.0/16 tenant 1
# opensase tenant add 10.2.0.0/16 tenant 2
# opensase tenant add 10.3.0.0/16 tenant 3

# ===============================================================
# NAT POOL CONFIGURATION
# ===============================================================

# Configure NAT pools per tenant
# opensase nat pool tenant 1 address 203.0.113.11 ports 10000-30000
# opensase nat pool tenant 2 address 203.0.113.12 ports 10000-30000

# ===============================================================
# VERIFICATION
# ===============================================================

# Display configuration
show interface
show interface address
show wireguard interface
show ip fib
show opensase version
