# OpenSASE VPP Engine - Startup Configuration (100 Gbps OPTIMIZED)
#
# This configuration is optimized for:
# - 2x 100GbE NICs (Mellanox ConnectX-6 or Intel E810)
# - 32+ CPU cores (AMD EPYC or Intel Xeon)
# - 64GB+ hugepages (1GB pages)
# - Target: <5Î¼s latency at 100 Gbps line rate
#
# File: /etc/vpp/startup.conf

unix {
  nodaemon
  interactive
  cli-listen /run/vpp/cli.sock
  gid vpp
  
  # Execute OpenSASE configuration after startup
  exec /etc/vpp/opensase.conf
  
  # Coredump for debugging
  coredump-size unlimited
  full-coredump
  
  # Log file
  log /var/log/vpp/vpp.log
  
  # Startup config file (this file)
  startup-config /etc/vpp/startup.conf
}

api-segment {
  gid vpp
  # Large shared memory for high-throughput API
  global-size 512M
  api-size 128M
}

# CPU Configuration - CRITICAL for performance
# Adjust cores based on your server (example: 32-core EPYC)
cpu {
  # Main thread on core 0 (not isolated)
  main-core 0
  
  # Workers on isolated cores
  # Use all cores except 0-3 (reserved for OS)
  # Example for 32-core: cores 4-31 = 28 workers
  corelist-workers 4-31
  
  # For 2-socket NUMA, pin workers evenly
  # Socket 0: cores 4-15 (12 workers)
  # Socket 1: cores 20-31 (12 workers, skip 16-19 for OS)
  # corelist-workers 4-15,20-31
  
  # Scheduler policy (FIFO for real-time)
  scheduler-policy fifo
  scheduler-priority 50
}

# Buffer Configuration - sized for 100 Gbps
buffers {
  # Large buffer pool (131072 = 128K buffers per NUMA)
  buffers-per-numa 131072
  
  # Buffer size (2048 standard, 3072 for jumbo frames)
  default data-size 2048
  
  # Pre-allocate buffers
  preallocate
}

# DPDK Configuration - 100 GbE NICs
dpdk {
  # Default device configuration for all NICs
  dev default {
    # Maximum queues for high parallelism
    num-rx-queues 16
    num-tx-queues 16
    
    # Large descriptor rings for burst handling
    num-rx-desc 4096
    num-tx-desc 4096
    
    # RSS (Receive Side Scaling) configuration
    rss-fn ipv4-udp ipv4-tcp
  }
  
  # First 100GbE NIC (adjust PCI address!)
  # Use 'lspci | grep -i ethernet' to find
  dev 0000:41:00.0 {
    name wan0
    # Pin to NUMA node 0
    # workers 0-13
  }
  
  # Second 100GbE NIC
  dev 0000:41:00.1 {
    name lan0
    # Pin to NUMA node 1
    # workers 14-27
  }
  
  # Memory per NUMA socket (MB)
  # For 64GB hugepages: 32GB per socket
  socket-mem 32768,32768
  
  # Performance optimizations
  no-multi-seg            # Single-segment buffers only
  no-tx-checksum-offload  # Software checksums (consistent latency)
  
  # Enable hardware timestamping (if available)
  # enable-tcp-udp-checksum
  
  # PMD (Poll Mode Driver) log level
  log-level pmd:warning
  
  # IOVA mode (PA = Physical Address for best performance)
  iova-mode pa
  
  # Huge directory (1GB pages)
  huge-dir /dev/hugepages
}

# Plugin Configuration
plugins {
  path /usr/lib/vpp_plugins
  
  # ===============================
  # OpenSASE Plugins (ENABLE)
  # ===============================
  plugin opensase_plugin.so { enable }
  plugin wireguard_tunnel_plugin.so { enable }
  
  # ===============================
  # Core VPP Plugins (ENABLE)
  # ===============================
  plugin dpdk_plugin.so { enable }
  plugin crypto_native_plugin.so { enable }
  plugin crypto_openssl_plugin.so { enable }
  
  # ===============================
  # Disabled for Performance
  # ===============================
  # NAT (we use opensase-nat)
  plugin nat44_ei_plugin.so { disable }
  plugin nat64_plugin.so { disable }
  plugin dnat44_plugin.so { disable }
  
  # ACL (we use opensase-policy)
  plugin acl_plugin.so { disable }
  
  # Other unnecessary plugins
  plugin lb_plugin.so { disable }
  plugin nsh_plugin.so { disable }
  plugin gtpu_plugin.so { disable }
  plugin pppoe_plugin.so { disable }
  plugin l2e_plugin.so { disable }
  plugin l2_emulation_plugin.so { disable }
  plugin lisp_plugin.so { disable }
  plugin tlsopenssl_plugin.so { disable }
  plugin tlsmbedtls_plugin.so { disable }
  plugin ikev2_plugin.so { disable }
  plugin lacp_plugin.so { disable }
  plugin memif_plugin.so { disable }
  plugin srv6_plugin.so { disable }
  plugin gbp_plugin.so { disable }
}

# Logging Configuration
logging {
  default-log-level info
  default-syslog-log-level warning
  
  # OpenSASE debugging
  class opensase/all { 
    level info
    rate-limit 1000
  }
  
  class dpdk/all { level warning }
  class vlib/all { level warning }
}

# Statistics Segment (for Prometheus/monitoring)
statseg {
  size 512M
  per-node-counters on
  update-interval 1.0
}

# Memory Heap
heapsize 8G

# Performance Tuning
punt {
  # Disable punt for maximum performance
  socket register
}

# Session Layer (if needed)
session {
  evt_qs_memfd_seg
  event-queue-length 2048
  preallocated-sessions 1000000
  v4-session-table-buckets 512000
  v4-halfopen-table-buckets 256000
}
