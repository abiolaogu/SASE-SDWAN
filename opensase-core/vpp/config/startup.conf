# OpenSASE VPP Engine - Startup Configuration
# Optimized for 100 Gbps with <5Î¼s latency
#
# File: /etc/vpp/startup.conf

unix {
    nodaemon
    cli-listen /run/vpp/cli.sock
    cli-line-mode
    log /var/log/vpp/vpp.log
    full-coredump
    startup-config /etc/vpp/setup.conf
    
    # Performance: disable poll sleep for minimum latency
    poll-sleep-usec 0
}

api-trace {
    on
    nitems 500000
}

api-segment {
    gid vpp
    global-size 512M
    api-size 128M
}

cpu {
    # Main thread on core 0
    main-core 0
    
    # Worker threads on isolated cores
    # For 100 Gbps: use 8-16 workers minimum
    # Adjust based on your CPU (example: cores 4-19 = 16 workers)
    corelist-workers 4-19
    
    # Alternative for 32+ core systems:
    # corelist-workers 4-31
    
    # skip-cores 1-3  # Reserve for OS
}

dpdk {
    # 100GbE NIC 1 (WAN-facing)
    dev 0000:41:00.0 {
        name wan0
        num-rx-queues 8
        num-tx-queues 8
        num-rx-desc 4096
        num-tx-desc 4096
        # RSS for flow distribution across workers
        rss-fn ipv4-tcp ipv4-udp ipv6-tcp ipv6-udp
    }
    
    # 100GbE NIC 2 (LAN-facing or second WAN)
    dev 0000:41:00.1 {
        name lan0
        num-rx-queues 8
        num-tx-queues 8
        num-rx-desc 4096
        num-tx-desc 4096
        rss-fn ipv4-tcp ipv4-udp ipv6-tcp ipv6-udp
    }
    
    # Memory: 8GB per NUMA node for packet buffers
    socket-mem 8192,8192
    
    # Hugepage configuration
    huge-dir /dev/hugepages
    
    # Increase mbuf pool for high PPS
    num-mbufs 524288
    
    # Multi-segment disabled for performance
    no-multi-seg
    
    # Enable hardware offloads
    enable-tcp-udp-checksum
    
    # IOVA mode (PA for best performance with IOMMU)
    iova-mode pa
}

buffers {
    # Buffer allocation per NUMA
    buffers-per-numa 524288
    
    # Larger buffers for jumbo frames
    default data-size 2048
    
    # Pre-allocate for performance
    preallocated-per-numa 262144
}

# Plugin Configuration
plugins {
    path /usr/lib/vpp_plugins
    
    # OpenSASE Plugins
    plugin opensase_plugin.so { enable }
    plugin wireguard_tunnel_plugin.so { enable }
    
    # Core VPP Plugins
    plugin dpdk_plugin.so { enable }
    plugin acl_plugin.so { enable }
    plugin nat44_ei_plugin.so { enable }
    plugin crypto_native_plugin.so { enable }
    plugin crypto_openssl_plugin.so { enable }
    
    # Disable unused plugins for performance
    plugin lb_plugin.so { disable }
    plugin nsh_plugin.so { disable }
    plugin gtpu_plugin.so { disable }
    plugin pppoe_plugin.so { disable }
    plugin lisp_plugin.so { disable }
    plugin srv6_plugin.so { disable }
}

# Logging - minimal for performance
logging {
    default-log-level warn
    default-syslog-log-level warn
    
    # Enable debug for troubleshooting if needed
    # class opensase/all { level debug }
}

# Statistics segment for monitoring
statseg {
    size 512M
    per-node-counters on
    update-interval 1.0
}

# Session layer configuration
session {
    evt_qs_memfd_seg
    event-queue-length 4096
    preallocated-sessions 1000000
    v4-session-table-buckets 512000
    v4-halfopen-table-buckets 256000
}

# Heap size
heapsize 8G
