# OpenSASE Layer 7 Gateway - Envoy Configuration
#
# High-performance L7 security gateway for:
# - Secure Web Gateway (SWG)
# - Cloud Access Security Broker (CASB)
# - Zero Trust Network Access (ZTNA)
#
# Target: 20 Gbps TLS-inspected HTTPS traffic

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
  access_log:
    - name: envoy.access_loggers.stdout
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog

node:
  id: opensase-gateway-${POD_NAME:-standalone}
  cluster: opensase-l7-gateway
  metadata:
    role: gateway
    version: "1.0.0"

# Dynamic configuration via xDS
dynamic_resources:
  lds_config:
    resource_api_version: V3
    api_config_source:
      api_type: GRPC
      transport_api_version: V3
      grpc_services:
        - envoy_grpc:
            cluster_name: xds_cluster
      set_node_on_first_message_only: true

  cds_config:
    resource_api_version: V3
    api_config_source:
      api_type: GRPC
      transport_api_version: V3
      grpc_services:
        - envoy_grpc:
            cluster_name: xds_cluster
      set_node_on_first_message_only: true

# Static resources (bootstrap)
static_resources:
  listeners:
    # ============================================
    # HTTPS Listener - Main SWG/CASB Entry Point
    # ============================================
    - name: https_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 443
      listener_filters:
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
      per_connection_buffer_limit_bytes: 1048576  # 1MB
      filter_chains:
        - filter_chain_match:
            transport_protocol: tls
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                tls_certificates:
                  - certificate_chain:
                      filename: /etc/envoy/certs/server.crt
                    private_key:
                      filename: /etc/envoy/certs/server.key
                alpn_protocols:
                  - h2
                  - http/1.1
                tls_params:
                  tls_minimum_protocol_version: TLSv1_2
                  tls_maximum_protocol_version: TLSv1_3
                  cipher_suites:
                    - ECDHE-ECDSA-AES256-GCM-SHA384
                    - ECDHE-RSA-AES256-GCM-SHA384
                    - ECDHE-ECDSA-AES128-GCM-SHA256
                    - ECDHE-RSA-AES128-GCM-SHA256
          filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: https_ingress
                codec_type: AUTO
                use_remote_address: true
                xff_num_trusted_hops: 1
                generate_request_id: true
                preserve_external_request_id: true
                
                # Access logging
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /var/log/envoy/access.json
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          request_id: "%REQ(X-REQUEST-ID)%"
                          method: "%REQ(:METHOD)%"
                          path: "%REQ(:PATH)%"
                          host: "%REQ(:AUTHORITY)%"
                          protocol: "%PROTOCOL%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_received: "%BYTES_RECEIVED%"
                          bytes_sent: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"
                          upstream_host: "%UPSTREAM_HOST%"
                          upstream_cluster: "%UPSTREAM_CLUSTER%"
                          downstream_remote_address: "%DOWNSTREAM_REMOTE_ADDRESS%"
                          user_agent: "%REQ(USER-AGENT)%"
                          x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
                          tenant_id: "%DYNAMIC_METADATA(opensase:tenant_id)%"
                          policy_action: "%DYNAMIC_METADATA(opensase:policy_action)%"
                
                # HTTP/2 settings
                http2_protocol_options:
                  max_concurrent_streams: 1000
                  initial_stream_window_size: 65536
                  initial_connection_window_size: 1048576
                
                # HTTP filters chain
                http_filters:
                  # ====================
                  # Authentication Filter
                  # ====================
                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        opensase_idp:
                          issuer: https://auth.opensase.io
                          audiences:
                            - opensase-gateway
                          remote_jwks:
                            http_uri:
                              uri: https://auth.opensase.io/.well-known/jwks.json
                              cluster: auth_cluster
                              timeout: 5s
                            cache_duration: 600s
                          forward: true
                          forward_payload_header: x-jwt-payload
                          payload_in_metadata: jwt_payload
                      rules:
                        - match:
                            prefix: /
                          requires:
                            provider_name: opensase_idp
                      bypass_cors_preflight: true
                  
                  # ====================
                  # Rate Limiting
                  # ====================
                  - name: envoy.filters.http.local_ratelimit
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                      stat_prefix: http_local_rate_limiter
                      token_bucket:
                        max_tokens: 10000
                        tokens_per_fill: 1000
                        fill_interval: 1s
                      filter_enabled:
                        runtime_key: local_rate_limit_enabled
                        default_value:
                          numerator: 100
                          denominator: HUNDRED
                      filter_enforced:
                        runtime_key: local_rate_limit_enforced
                        default_value:
                          numerator: 100
                          denominator: HUNDRED
                      response_headers_to_add:
                        - append_action: OVERWRITE_IF_EXISTS_OR_ADD
                          header:
                            key: x-local-rate-limit
                            value: "true"
                  
                  # ====================
                  # WASM URL Filter (SWG)
                  # ====================
                  - name: envoy.filters.http.wasm
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
                      config:
                        name: "url_filter"
                        root_id: "url_filter"
                        vm_config:
                          runtime: envoy.wasm.runtime.v8
                          code:
                            local:
                              filename: /etc/envoy/wasm/url_filter.wasm
                          allow_precompiled: true
                        configuration:
                          "@type": type.googleapis.com/google.protobuf.StringValue
                          value: |
                            {
                              "blocked_categories": ["malware", "phishing", "gambling"],
                              "allowed_categories": ["business", "technology"],
                              "log_level": "info"
                            }
                  
                  # ====================
                  # WASM DLP Filter
                  # ====================
                  - name: envoy.filters.http.wasm
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
                      config:
                        name: "dlp_filter"
                        root_id: "dlp_filter"
                        vm_config:
                          runtime: envoy.wasm.runtime.v8
                          code:
                            local:
                              filename: /etc/envoy/wasm/dlp_filter.wasm
                          allow_precompiled: true
                        configuration:
                          "@type": type.googleapis.com/google.protobuf.StringValue
                          value: |
                            {
                              "enabled": true,
                              "patterns": ["SSN", "CREDIT_CARD", "API_KEY"],
                              "action": "block"
                            }
                  
                  # ====================
                  # WASM CASB Filter
                  # ====================
                  - name: envoy.filters.http.wasm
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
                      config:
                        name: "casb_filter"
                        root_id: "casb_filter"
                        vm_config:
                          runtime: envoy.wasm.runtime.v8
                          code:
                            local:
                              filename: /etc/envoy/wasm/casb_filter.wasm
                          allow_precompiled: true
                        configuration:
                          "@type": type.googleapis.com/google.protobuf.StringValue
                          value: |
                            {
                              "saas_apps": {
                                "microsoft365": {"allowed": true, "dlp": true},
                                "google_workspace": {"allowed": true, "dlp": true},
                                "salesforce": {"allowed": true, "dlp": false},
                                "dropbox": {"allowed": false}
                              }
                            }
                  
                  # ====================
                  # Lua Script (Tenant Extraction)
                  # ====================
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      default_source_code:
                        inline_string: |
                          function envoy_on_request(request_handle)
                            -- Extract tenant from JWT or header
                            local jwt_payload = request_handle:headers():get("x-jwt-payload")
                            if jwt_payload then
                              -- Decode and extract tenant_id
                              request_handle:streamInfo():dynamicMetadata():set(
                                "opensase", "tenant_id", "extracted_from_jwt"
                              )
                            end
                            
                            -- Add tracing headers
                            local request_id = request_handle:headers():get("x-request-id")
                            if not request_id then
                              request_handle:headers():add("x-request-id", 
                                request_handle:streamInfo():filterState():getStringValue("request_id") or "unknown"
                              )
                            end
                          end
                          
                          function envoy_on_response(response_handle)
                            -- Add security headers
                            response_handle:headers():add("X-Content-Type-Options", "nosniff")
                            response_handle:headers():add("X-Frame-Options", "DENY")
                            response_handle:headers():add("Strict-Transport-Security", 
                              "max-age=31536000; includeSubDomains")
                          end
                  
                  # ====================
                  # Router (must be last)
                  # ====================
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                      suppress_envoy_headers: true
                
                # Route configuration
                route_config:
                  name: local_route
                  virtual_hosts:
                    # SaaS Applications (CASB)
                    - name: microsoft365
                      domains:
                        - "*.microsoft.com"
                        - "*.office.com"
                        - "*.office365.com"
                        - "*.microsoftonline.com"
                      routes:
                        - match:
                            prefix: /
                          route:
                            cluster: microsoft365_cluster
                            timeout: 30s
                    
                    - name: google_workspace
                      domains:
                        - "*.google.com"
                        - "*.googleapis.com"
                        - "*.gstatic.com"
                      routes:
                        - match:
                            prefix: /
                          route:
                            cluster: google_cluster
                            timeout: 30s
                    
                    # Forward Proxy (catch-all)
                    - name: forward_proxy
                      domains:
                        - "*"
                      routes:
                        - match:
                            prefix: /
                          route:
                            cluster: dynamic_forward_proxy_cluster
                            timeout: 60s

    # ============================================
    # HTTP Listener (Redirect to HTTPS)
    # ============================================
    - name: http_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 80
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: http_redirect
                codec_type: AUTO
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: redirect_route
                  virtual_hosts:
                    - name: redirect_all
                      domains:
                        - "*"
                      routes:
                        - match:
                            prefix: /
                          redirect:
                            https_redirect: true
                            response_code: MOVED_PERMANENTLY

    # ============================================
    # ZTNA Listener (Private Application Access)
    # ============================================
    - name: ztna_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8443
      listener_filters:
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
      filter_chains:
        - filter_chain_match:
            transport_protocol: tls
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              require_client_certificate: true
              common_tls_context:
                tls_certificates:
                  - certificate_chain:
                      filename: /etc/envoy/certs/server.crt
                    private_key:
                      filename: /etc/envoy/certs/server.key
                validation_context:
                  trusted_ca:
                    filename: /etc/envoy/certs/ca.crt
                alpn_protocols:
                  - h2
                  - http/1.1
          filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ztna_ingress
                codec_type: AUTO
                http_filters:
                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        opensase_idp:
                          issuer: https://auth.opensase.io
                          audiences:
                            - opensase-ztna
                          remote_jwks:
                            http_uri:
                              uri: https://auth.opensase.io/.well-known/jwks.json
                              cluster: auth_cluster
                              timeout: 5s
                      rules:
                        - match:
                            prefix: /
                          requires:
                            provider_name: opensase_idp
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: ztna_route
                  virtual_hosts:
                    - name: private_apps
                      domains:
                        - "*"
                      routes:
                        - match:
                            prefix: /app/internal-dashboard
                          route:
                            cluster: internal_dashboard_cluster
                        - match:
                            prefix: /app/erp
                          route:
                            cluster: erp_cluster
                        - match:
                            prefix: /
                          direct_response:
                            status: 403
                            body:
                              inline_string: "Access Denied: Application not found or not authorized"

  clusters:
    # xDS Control Plane
    - name: xds_cluster
      type: STRICT_DNS
      connect_timeout: 10s
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {}
      load_assignment:
        cluster_name: xds_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: xds-server
                      port_value: 18000

    # Auth Service (JWKS)
    - name: auth_cluster
      type: STRICT_DNS
      connect_timeout: 5s
      load_assignment:
        cluster_name: auth_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: auth.opensase.io
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: auth.opensase.io

    # Microsoft 365 Cluster
    - name: microsoft365_cluster
      type: LOGICAL_DNS
      connect_timeout: 10s
      dns_lookup_family: V4_ONLY
      load_assignment:
        cluster_name: microsoft365_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: outlook.office365.com
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: outlook.office365.com

    # Google Workspace Cluster
    - name: google_cluster
      type: LOGICAL_DNS
      connect_timeout: 10s
      dns_lookup_family: V4_ONLY
      load_assignment:
        cluster_name: google_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: www.googleapis.com
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: www.googleapis.com

    # Dynamic Forward Proxy (for any hostname)
    - name: dynamic_forward_proxy_cluster
      connect_timeout: 10s
      lb_policy: CLUSTER_PROVIDED
      cluster_type:
        name: envoy.clusters.dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
          dns_cache_config:
            name: dynamic_forward_proxy_cache
            dns_lookup_family: V4_ONLY
            max_hosts: 10000
            dns_refresh_rate: 60s

    # ZTNA Internal Dashboard
    - name: internal_dashboard_cluster
      type: STRICT_DNS
      connect_timeout: 5s
      load_assignment:
        cluster_name: internal_dashboard_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: internal-dashboard.private
                      port_value: 8080

    # ZTNA ERP Cluster
    - name: erp_cluster
      type: STRICT_DNS
      connect_timeout: 5s
      load_assignment:
        cluster_name: erp_cluster
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: erp.private
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext

# Layered runtime configuration
layered_runtime:
  layers:
    - name: static_layer
      static_layer:
        envoy:
          resource_limits:
            listener:
              https_listener:
                connection_limit: 100000
        overload:
          global_downstream_max_connections: 50000
