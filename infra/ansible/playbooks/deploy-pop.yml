# OpenSASE Ansible Main Playbook
# Complete PoP configuration

---
- name: OpenSASE PoP Configuration
  hosts: pop_nodes
  become: yes
  vars:
    opensase_version: "1.0.0"
    vpp_version: "23.10"
    flexiwan_version: "latest"
    
  tasks:
    # ===========================================
    # Pre-flight Checks
    # ===========================================
    
    - name: Gather facts
      setup:
        gather_subset:
          - hardware
          - network
    
    - name: Verify minimum requirements
      assert:
        that:
          - ansible_memtotal_mb >= 8192
          - ansible_processor_vcpus >= 4
        fail_msg: "Minimum requirements not met: 8GB RAM, 4 vCPUs"
    
    # ===========================================
    # System Configuration
    # ===========================================
    
    - name: Configure hostname
      hostname:
        name: "{{ pop_name }}"
    
    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 {{ pop_name }}"
        state: present
    
    - name: Configure timezone
      timezone:
        name: UTC
    
    - name: Configure sysctl for VPP
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop: "{{ sysctl_settings | dict2items }}"
      vars:
        sysctl_settings:
          vm.nr_hugepages: 1024
          vm.hugetlb_shm_group: 0
          net.core.rmem_max: 134217728
          net.core.wmem_max: 134217728
          net.core.netdev_max_backlog: 250000
          net.ipv4.ip_forward: 1
    
    # ===========================================
    # VPP Role
    # ===========================================
    
    - name: Include VPP role
      include_role:
        name: vpp
    
    # ===========================================
    # FlexiEdge Role
    # ===========================================
    
    - name: Include FlexiEdge role
      include_role:
        name: flexiedge
    
    # ===========================================
    # Suricata Role
    # ===========================================
    
    - name: Include Suricata role
      include_role:
        name: suricata
    
    # ===========================================
    # Monitoring Role
    # ===========================================
    
    - name: Include Monitoring role
      include_role:
        name: monitoring
    
    # ===========================================
    # Health Check
    # ===========================================
    
    - name: Wait for services to be ready
      wait_for:
        port: "{{ item.port }}"
        host: 127.0.0.1
        timeout: 60
      loop:
        - { port: 8080, name: "Health API" }
        - { port: 9100, name: "Node Exporter" }
    
    - name: Verify health endpoint
      uri:
        url: http://127.0.0.1:8080/health
        return_content: yes
      register: health_check
      until: health_check.json.status == 'healthy'
      retries: 10
      delay: 10
    
    - name: Print deployment summary
      debug:
        msg: |
          ============================================
          OpenSASE PoP Deployment Complete!
          ============================================
          PoP Name:    {{ pop_name }}
          Host:        {{ ansible_hostname }}
          IP:          {{ ansible_default_ipv4.address }}
          VPP:         {{ vpp_version }}
          FlexiWAN:    {{ flexiwan_version }}
          Health:      {{ health_check.json.status }}
          ============================================
