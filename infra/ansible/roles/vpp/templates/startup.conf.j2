# OpenSASE VPP Configuration - 100 Gbps Optimized
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

unix {
    nodaemon
    cli-listen /run/vpp/cli.sock
    cli-line-mode
    log /var/log/vpp/vpp.log
    full-coredump
    startup-config /etc/vpp/setup.conf
    poll-sleep-usec 0
    gid vpp
}

api-trace {
    on
    nitems 500000
}

api-segment {
    gid vpp
}

socksvr {
    default
}

statseg {
    size 512M
    per-node-counters on
}

cpu {
    main-core {{ vpp_main_core | default(0) }}
{% if vpp_worker_cores is defined %}
    corelist-workers {{ vpp_worker_cores | join(',') }}
{% else %}
    corelist-workers {{ range(1, vpp_workers + 1) | list | join(',') }}
{% endif %}
{% if ansible_processor_nproc > 32 %}
    skip-cores 1-3
{% endif %}
    scheduler-policy fifo
    scheduler-priority 50
}

dpdk {
    dev default {
        num-rx-queues {{ vpp_rx_queues | default(4) }}
        num-tx-queues {{ vpp_tx_queues | default(4) }}
        num-rx-desc {{ vpp_rx_ring_size | default(4096) }}
        num-tx-desc {{ vpp_tx_ring_size | default(4096) }}
    }

{% for iface in vpp_interfaces %}
    dev {{ iface.pci }} {
        name {{ iface.name }}
{% if iface.workers is defined %}
        workers {{ iface.workers | join(' ') }}
{% endif %}
{% if iface.mtu is defined %}
        mtu {{ iface.mtu }}
{% endif %}
        rss-fn ipv4-tcp ipv4-udp ipv6-tcp ipv6-udp
    }
{% endfor %}

    socket-mem {{ (hugepages_1g | default(8)) * 1024 }},{{ (hugepages_1g | default(8)) * 1024 }}
    huge-dir /dev/hugepages
    num-mbufs 524288
    no-multi-seg
    enable-tcp-udp-checksum
}

buffers {
    buffers-per-numa 524288
    default data-size 2048
    preallocated-per-numa 262144
}

plugins {
    plugin default { enable }
    plugin dpdk_plugin.so { enable }
    plugin wireguard_plugin.so { enable }
    plugin acl_plugin.so { enable }
    plugin nat_plugin.so { enable }
{% if ipsec_enabled | default(false) %}
    plugin crypto_native_plugin.so { enable }
    plugin crypto_ipsecmb_plugin.so { enable }
{% endif %}
}

logging {
    default-log-level warn
    default-syslog-log-level warn
}
