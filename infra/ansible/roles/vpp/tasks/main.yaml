# VPP Role - Data Plane Installation
# Estimated time: 4 minutes

---
- name: Add VPP repository key
  apt_key:
    url: https://packagecloud.io/fdio/release/gpgkey
    state: present

- name: Add VPP repository
  apt_repository:
    repo: "deb https://packagecloud.io/fdio/release/ubuntu {{ ansible_distribution_release }} main"
    state: present
    filename: fdio-release

- name: Update apt cache
  apt:
    update_cache: true

- name: Install VPP packages
  apt:
    name:
      - vpp={{ vpp_version }}*
      - vpp-plugin-core={{ vpp_version }}*
      - vpp-plugin-dpdk={{ vpp_version }}*
      - vpp-dev={{ vpp_version }}*
      - libvppinfra={{ vpp_version }}*
    state: present
  notify: restart vpp

- name: Create VPP directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/vpp
    - /run/vpp
    - /var/log/vpp

- name: Generate VPP startup configuration
  template:
    src: startup.conf.j2
    dest: /etc/vpp/startup.conf
    mode: '0644'
  notify: restart vpp

- name: Generate VPP interface configuration
  template:
    src: interfaces.conf.j2
    dest: /etc/vpp/interfaces.conf
    mode: '0644'
  notify: restart vpp

- name: Generate VPP exec script
  template:
    src: vpp-exec.conf.j2
    dest: /etc/vpp/vpp-exec.conf
    mode: '0644'
  notify: restart vpp

- name: Create VPP systemd override directory
  file:
    path: /etc/systemd/system/vpp.service.d
    state: directory
    mode: '0755'

- name: Configure VPP systemd overrides
  copy:
    content: |
      [Service]
      LimitNOFILE=1048576
      LimitMEMLOCK=infinity
      ExecStartPre=/sbin/modprobe vfio-pci
    dest: /etc/systemd/system/vpp.service.d/override.conf
    mode: '0644'
  notify: daemon reload

- name: Enable and start VPP
  systemd:
    name: vpp
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for VPP to be ready
  wait_for:
    path: /run/vpp/cli.sock
    timeout: 60

- name: Verify VPP is running
  command: vppctl show version
  register: vpp_version_check
  changed_when: false
  retries: 3
  delay: 5

- name: Display VPP version
  debug:
    msg: "VPP Version: {{ vpp_version_check.stdout_lines[0] }}"

- name: Configure VPP interfaces
  command: "vppctl {{ item }}"
  loop: "{{ vpp_interface_commands | default([]) }}"
  changed_when: false
  when: vpp_interface_commands is defined

- name: Create WireGuard interface (if configured)
  command: |
    vppctl wireguard create listen-port {{ wg_mesh_port }} \
      private-key {{ wg_private_key }} \
      src {{ wg_local_ip }}
  when: wg_enabled | default(true)
  register: wg_create
  changed_when: "'sw_if_index' in wg_create.stdout"
  ignore_errors: true

- name: Register VPP status
  set_fact:
    vpp_status: "running"
