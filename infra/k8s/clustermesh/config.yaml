# Cilium Cluster Mesh Configuration
# Multi-PoP connectivity for OpenSASE

---
apiVersion: cilium.io/v2alpha1
kind: CiliumClusterConfig
metadata:
  name: opensase-global-mesh
spec:
  clusters:
    # North America
    - name: opensase-nyc1
      address: https://clustermesh.nyc1.opensase.io:2379
      
    - name: opensase-ash1
      address: https://clustermesh.ash1.opensase.io:2379
      
    - name: opensase-lax1
      address: https://clustermesh.lax1.opensase.io:2379
    
    # Europe
    - name: opensase-fra1
      address: https://clustermesh.fra1.opensase.io:2379
      
    - name: opensase-lon1
      address: https://clustermesh.lon1.opensase.io:2379
      
    - name: opensase-ams1
      address: https://clustermesh.ams1.opensase.io:2379
    
    # Asia Pacific
    - name: opensase-sgp1
      address: https://clustermesh.sgp1.opensase.io:2379
      
    - name: opensase-tok1
      address: https://clustermesh.tok1.opensase.io:2379
      
    - name: opensase-hkg1
      address: https://clustermesh.hkg1.opensase.io:2379

---
# =============================================================================
# Global Services (available at all PoPs)
# =============================================================================

apiVersion: v1
kind: Service
metadata:
  name: api-server-global
  namespace: opensase
  annotations:
    io.cilium/global-service: "true"
    io.cilium/shared-service: "true"
spec:
  selector:
    app: api-server
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: grpc
      port: 50051
      targetPort: 50051

---
apiVersion: v1
kind: Service
metadata:
  name: portal-global
  namespace: opensase
  annotations:
    io.cilium/global-service: "true"
spec:
  selector:
    app: portal
  ports:
    - name: http
      port: 3000
      targetPort: 3000

---
# =============================================================================
# Service Affinity (prefer local, fallback to remote)
# =============================================================================

apiVersion: v1
kind: Service
metadata:
  name: api-server-local-first
  namespace: opensase
  annotations:
    io.cilium/global-service: "true"
    io.cilium/service-affinity: "local"
spec:
  selector:
    app: api-server
  ports:
    - name: http
      port: 8080
      targetPort: 8080

---
# =============================================================================
# Cluster Mesh Network Policy
# Allow traffic between clusters for global services
# =============================================================================

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-cluster-mesh
  namespace: opensase
spec:
  endpointSelector:
    matchLabels:
      component: control-plane
  ingress:
    - fromEndpoints:
        - matchLabels:
            io.cilium.k8s.policy.cluster: opensase-nyc1
        - matchLabels:
            io.cilium.k8s.policy.cluster: opensase-fra1
        - matchLabels:
            io.cilium.k8s.policy.cluster: opensase-lon1
        - matchLabels:
            io.cilium.k8s.policy.cluster: opensase-sgp1
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
            - port: "50051"
              protocol: TCP

---
# =============================================================================
# Cluster Mesh Secrets (auto-generated by Cilium)
# Template for manual setup
# =============================================================================

apiVersion: v1
kind: Secret
metadata:
  name: cilium-clustermesh
  namespace: kube-system
type: Opaque
data:
  # These would be auto-populated or manually set
  # ca.crt: <base64-ca-cert>
  # tls.crt: <base64-tls-cert>
  # tls.key: <base64-tls-key>
  # etcd-client-ca.crt: <base64-etcd-ca>
