# Talos Linux Kubernetes Configuration
# OpenSASE Control Plane Platform
#
# Immutable, secure K8s for PoP control plane services
# Runs on 3 nodes per PoP for HA

version: v1alpha1
debug: false
persist: true

machine:
  type: controlplane
  token: ${TALOS_TOKEN}
  
  # Installation
  install:
    disk: /dev/nvme0n1
    image: ghcr.io/siderolabs/installer:v1.6.0
    bootloader: true
    wipe: true
    
  # Certificate SANs
  certSANs:
    - ${CONTROL_PLANE_VIP}
    - ${PUBLIC_IP}
    - api.${POP_NAME}.opensase.io
    
  # Kubelet configuration
  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.29.0
    defaultRuntimeSeccompProfileEnabled: true
    extraArgs:
      rotate-server-certificates: true
      max-pods: 110
    clusterDNS:
      - 10.96.0.10
    nodeIP:
      validSubnets:
        - ${MGMT_SUBNET}
        
  # Network configuration
  network:
    hostname: opensase-${POP_NAME}-cp-${NODE_INDEX}
    interfaces:
      # Management interface (1GbE)
      - interface: eth0
        dhcp: false
        addresses:
          - ${MGMT_IP}/24
        routes:
          - network: 0.0.0.0/0
            gateway: ${MGMT_GW}
        mtu: 1500
        
      # Pod network interface (10GbE)
      - interface: eth1
        dhcp: false
        addresses:
          - ${POD_NET_IP}/24
        mtu: 9000  # Jumbo frames for performance
        
      # VIP for control plane HA
      - interface: eth0
        vip:
          ip: ${CONTROL_PLANE_VIP}
          
    # DNS resolvers
    nameservers:
      - 1.1.1.1
      - 8.8.8.8
      
  # Time synchronization
  time:
    disabled: false
    servers:
      - time.cloudflare.com
      
  # System features
  features:
    rbac: true
    stableHostname: true
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    kubePrism:
      enabled: true
    hostDNS:
      enabled: true
      
  # Kernel parameters for performance
  sysctls:
    net.core.somaxconn: "65535"
    net.ipv4.tcp_max_syn_backlog: "65535"
    net.core.rmem_max: "16777216"
    net.core.wmem_max: "16777216"
    net.ipv4.tcp_rmem: "4096 87380 16777216"
    net.ipv4.tcp_wmem: "4096 65536 16777216"
    net.ipv4.tcp_congestion_control: "bbr"
    net.core.default_qdisc: "fq"
    net.ipv4.ip_forward: "1"
    fs.inotify.max_user_watches: "1048576"
    fs.inotify.max_user_instances: "8192"
    
  # Files to create
  files:
    # VPP socket path for gateway access
    - content: |
        [Manager]
        DefaultEnvironment="VPP_SOCKET=/run/vpp/cli.sock"
      permissions: 0644
      path: /etc/systemd/system.conf.d/vpp-env.conf
      op: create

cluster:
  id: ${CLUSTER_ID}
  secret: ${CLUSTER_SECRET}
  
  # Control plane endpoint (VIP)
  controlPlane:
    endpoint: https://${CONTROL_PLANE_VIP}:6443
    
  clusterName: opensase-${POP_NAME}
  
  # Network configuration
  network:
    cni:
      name: none  # Cilium will be installed separately
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/12
    dnsDomain: cluster.local
    
  # Disable kube-proxy (Cilium replaces it)
  proxy:
    disabled: true
    
  # etcd configuration
  etcd:
    advertisedSubnets:
      - ${MGMT_SUBNET}
    extraArgs:
      quota-backend-bytes: "8589934592"  # 8GB
      auto-compaction-mode: periodic
      auto-compaction-retention: "1h"
      
  # CoreDNS configuration
  coreDNS:
    disabled: false
    image: docker.io/coredns/coredns:1.11.1
    
  # API server configuration
  apiServer:
    certSANs:
      - ${CONTROL_PLANE_VIP}
      - ${PUBLIC_IP}
    extraArgs:
      oidc-issuer-url: https://auth.opensase.io
      oidc-client-id: kubernetes
      oidc-username-claim: email
      oidc-groups-claim: groups
    admissionControl:
      - name: PodSecurity
        configuration:
          apiVersion: pod-security.admission.config.k8s.io/v1
          kind: PodSecurityConfiguration
          defaults:
            enforce: "restricted"
            audit: "restricted"
            warn: "restricted"
            
  # Controller manager
  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0
      
  # Scheduler
  scheduler:
    extraArgs:
      bind-address: 0.0.0.0
      
  # Allow scheduling on control plane nodes (small clusters)
  allowSchedulingOnControlPlanes: true
  
  # Admin kubeconfig
  adminKubeconfig:
    certLifetime: 1y
