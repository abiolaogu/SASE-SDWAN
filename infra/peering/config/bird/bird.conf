################################################################################
# OpenSASE Peering Engine - Production BIRD 2 Configuration
# /config/bird/bird.conf
# 
# Complete BGP configuration for IXP peering with:
# - RPKI validation
# - Bogon filtering  
# - IXP route servers
# - Bilateral peering
################################################################################

#===============================================================================
# Router Identity
#===============================================================================

# Router ID (use primary IP)
router id 203.0.113.1;

# Hostname for identification
hostname "ospe-router";

# Define our AS
define MY_ASN = 65001;  # Replace with your ASN

#===============================================================================
# Prefix Definitions
#===============================================================================

# Our IPv4 prefixes
define MY_PREFIXES_V4 = [
    203.0.113.0/24,     # Anycast prefix
    198.51.100.0/24     # Customer prefix
];

# Our IPv6 prefixes
define MY_PREFIXES_V6 = [
    2001:db8::/32
];

# Bogon prefixes - never accept or announce
define BOGONS_V4 = [
    0.0.0.0/8+,          # RFC 1122 'this' network
    10.0.0.0/8+,         # RFC 1918 private
    100.64.0.0/10+,      # RFC 6598 CGN
    127.0.0.0/8+,        # RFC 1122 loopback
    169.254.0.0/16+,     # RFC 3927 link-local
    172.16.0.0/12+,      # RFC 1918 private
    192.0.0.0/24+,       # RFC 6890 IETF protocol
    192.0.2.0/24+,       # RFC 5737 TEST-NET-1
    192.168.0.0/16+,     # RFC 1918 private
    198.18.0.0/15+,      # RFC 2544 benchmark
    198.51.100.0/24+,    # RFC 5737 TEST-NET-2
    203.0.113.0/24+,     # RFC 5737 TEST-NET-3
    224.0.0.0/4+,        # RFC 5771 multicast
    240.0.0.0/4+         # RFC 1112 reserved
];

define BOGONS_V6 = [
    ::/8+,               # Loopback, unspecified
    0100::/64+,          # Discard prefix
    2001:2::/48+,        # BMWG
    2001:10::/28+,       # ORCHID
    2001:db8::/32+,      # Documentation
    fc00::/7+,           # Unique local
    fe80::/10+,          # Link-local
    ff00::/8+            # Multicast
];

# Bogon ASNs - reject paths containing these
define BOGON_ASNS = [
    0,                    # Reserved
    23456,                # AS_TRANS
    64496..64511,         # Documentation
    64512..65534,         # Private use
    65535,                # Reserved
    65536..65551,         # Documentation
    4200000000..4294967294, # Private use (32-bit)
    4294967295            # Reserved
];

#===============================================================================
# BGP Communities
#===============================================================================

define COMM_IXP_LEARNED      = (MY_ASN, 100);
define COMM_TRANSIT_LEARNED  = (MY_ASN, 200);
define COMM_CUSTOMER_LEARNED = (MY_ASN, 300);
define COMM_NO_EXPORT_PEERS  = (MY_ASN, 1000);
define COMM_NO_EXPORT_TRANSIT = (MY_ASN, 1001);
define COMM_BLACKHOLE        = (MY_ASN, 666);

# Regional communities
define COMM_REGION_NA   = (MY_ASN, 10);
define COMM_REGION_EU   = (MY_ASN, 20);
define COMM_REGION_APAC = (MY_ASN, 30);

#===============================================================================
# Logging
#===============================================================================

log syslog all;
log "/var/log/bird/bird.log" { debug, trace, info, remote, warning, error, auth, fatal, bug };

#===============================================================================
# Base Protocols
#===============================================================================

# Device protocol - interface scanning
protocol device {
    scan time 10;
}

# Direct protocol - connected routes
protocol direct {
    ipv4;
    ipv6;
    interface "lo";
    interface "vpp*";
    interface "eth*";
}

# Kernel protocol - IPv4
protocol kernel kernel4 {
    ipv4 {
        import none;
        export filter {
            if source = RTS_BGP then accept;
            if source = RTS_STATIC then accept;
            reject;
        };
    };
    learn;
    persist;
    graceful restart;
    scan time 20;
}

# Kernel protocol - IPv6
protocol kernel kernel6 {
    ipv6 {
        import none;
        export filter {
            if source = RTS_BGP then accept;
            if source = RTS_STATIC then accept;
            reject;
        };
    };
    learn;
    persist;
    graceful restart;
    scan time 20;
}

# Static routes for our prefixes
protocol static static_v4 {
    ipv4;
    route 203.0.113.0/24 reject;
    route 198.51.100.0/24 reject;
}

protocol static static_v6 {
    ipv6;
    route 2001:db8::/32 reject;
}

#===============================================================================
# Route Origin Validation (RPKI)
#===============================================================================

roa4 table roa_v4;
roa6 table roa_v6;

# RPKI validator (Cloudflare, Routinator, or local)
protocol rpki rpki_cloudflare {
    roa4 { table roa_v4; };
    roa6 { table roa_v6; };
    remote "rpki.cloudflare.com" port 8282;
    retry keep 90;
    refresh keep 900;
    expire keep 172800;
}

# Backup RPKI validator (local Routinator)
# protocol rpki rpki_local {
#     roa4 { table roa_v4; };
#     roa6 { table roa_v6; };
#     remote "127.0.0.1" port 3323;
#     retry keep 90;
#     refresh keep 900;
#     expire keep 172800;
# }

#===============================================================================
# BFD - Bidirectional Forwarding Detection
#===============================================================================

protocol bfd {
    interface "vpp*" {
        min rx interval 100 ms;
        min tx interval 100 ms;
        idle tx interval 500 ms;
        multiplier 3;
    };
    interface "eth*" {
        min rx interval 300 ms;
        min tx interval 300 ms;
        multiplier 5;
    };
}

#===============================================================================
# Filter Functions
#===============================================================================

# Check for bogon prefixes
function is_bogon_v4() {
    if net ~ BOGONS_V4 then return true;
    return false;
}

function is_bogon_v6() {
    if net ~ BOGONS_V6 then return true;
    return false;
}

# Check for bogon ASN in path
function has_bogon_asn() {
    if bgp_path ~ BOGON_ASNS then return true;
    return false;
}

# RPKI validation functions
function rpki_valid_v4() {
    return roa_check(roa_v4, net, bgp_path.last) = ROA_VALID;
}

function rpki_invalid_v4() {
    return roa_check(roa_v4, net, bgp_path.last) = ROA_INVALID;
}

function rpki_unknown_v4() {
    return roa_check(roa_v4, net, bgp_path.last) = ROA_UNKNOWN;
}

#===============================================================================
# Import/Export Filters
#===============================================================================

# Export to IXP peers
filter export_to_peers {
    # Only announce our own prefixes
    if net ~ MY_PREFIXES_V4 then accept;
    
    # Export static routes
    if source = RTS_STATIC then accept;
    
    # Export customer routes
    if COMM_CUSTOMER_LEARNED ~ bgp_community then accept;
    
    # Check no-export communities
    if COMM_NO_EXPORT_PEERS ~ bgp_community then reject;
    
    reject;
}

# Import from IXP peers
filter import_from_peers {
    # Reject bogon prefixes
    if is_bogon_v4() then {
        print "Rejecting bogon prefix: ", net;
        reject;
    }
    
    # Reject bogon ASNs in path
    if has_bogon_asn() then {
        print "Rejecting bogon ASN in path: ", net, " path: ", bgp_path;
        reject;
    }
    
    # Reject RPKI invalid routes
    if rpki_invalid_v4() then {
        print "Rejecting RPKI invalid: ", net, " origin: ", bgp_path.last;
        reject;
    }
    
    # Reject too specific prefixes
    if net.len > 24 then reject;
    
    # Reject too short prefixes (probably leaks)
    if net.len < 8 then reject;
    
    # Reject overly long AS paths
    if bgp_path.len > 64 then reject;
    
    # Reject AS path with our own ASN (loop prevention)
    if bgp_path ~ [= * MY_ASN * =] then reject;
    
    # Tag with IXP learned community
    bgp_community.add(COMM_IXP_LEARNED);
    
    # Set local preference
    bgp_local_pref = 150;
    
    # Boost RPKI valid routes
    if rpki_valid_v4() then bgp_local_pref = 160;
    
    accept;
}

# Import from transit providers (lower preference)
filter import_from_transit {
    if is_bogon_v4() then reject;
    if has_bogon_asn() then reject;
    if rpki_invalid_v4() then reject;
    if net.len > 24 then reject;
    if bgp_path.len > 100 then reject;
    
    bgp_community.add(COMM_TRANSIT_LEARNED);
    bgp_local_pref = 100;
    
    if rpki_valid_v4() then bgp_local_pref = 110;
    
    accept;
}

# Export to transit providers
filter export_to_transit {
    if net ~ MY_PREFIXES_V4 then accept;
    if source = RTS_STATIC then accept;
    if COMM_CUSTOMER_LEARNED ~ bgp_community then accept;
    if COMM_NO_EXPORT_TRANSIT ~ bgp_community then reject;
    
    reject;
}

# Import from customers (highest preference)
filter import_from_customers {
    if is_bogon_v4() then reject;
    if net.len > 24 then reject;
    
    bgp_community.add(COMM_CUSTOMER_LEARNED);
    bgp_local_pref = 200;
    
    accept;
}

# Export full table to customers
filter export_to_customers {
    # Export everything except blackholed routes
    if COMM_BLACKHOLE ~ bgp_community then reject;
    accept;
}

#===============================================================================
# BGP Templates
#===============================================================================

# Template for IXP route servers
template bgp tpl_ixp_rs {
    local as MY_ASN;
    graceful restart on;
    long lived graceful restart on;
    
    ipv4 {
        import filter import_from_peers;
        export filter export_to_peers;
        import limit 250000 action restart;
        receive limit 300000 action disable;
    };
}

# Template for bilateral IXP peers
template bgp tpl_bilateral {
    local as MY_ASN;
    graceful restart on;
    
    ipv4 {
        import filter import_from_peers;
        export filter export_to_peers;
        import limit 50000 action restart;
    };
}

# Template for transit providers
template bgp tpl_transit {
    local as MY_ASN;
    graceful restart on;
    default bgp_local_pref 100;
    
    ipv4 {
        import filter import_from_transit;
        export filter export_to_transit;
        import limit 900000 action restart;  # Full table
    };
}

# Template for customers
template bgp tpl_customer {
    local as MY_ASN;
    graceful restart on;
    default bgp_local_pref 200;
    
    ipv4 {
        import filter import_from_customers;
        export filter export_to_customers;
        import limit 100 action restart;
    };
}

#===============================================================================
# IXP Route Server Sessions
#===============================================================================

# DE-CIX Frankfurt Route Servers
protocol bgp rs_decix_1 from tpl_ixp_rs {
    neighbor 80.81.192.157 as 6695;
    description "DE-CIX Frankfurt RS1";
    # source address 80.81.192.XXX;  # Your DE-CIX IP
}

protocol bgp rs_decix_2 from tpl_ixp_rs {
    neighbor 80.81.192.158 as 6695;
    description "DE-CIX Frankfurt RS2";
}

# AMS-IX Route Servers
protocol bgp rs_amsix_1 from tpl_ixp_rs {
    neighbor 80.249.208.31 as 6777;
    description "AMS-IX RS1";
}

protocol bgp rs_amsix_2 from tpl_ixp_rs {
    neighbor 80.249.208.32 as 6777;
    description "AMS-IX RS2";
}

# LINX LON1 Route Servers
protocol bgp rs_linx_1 from tpl_ixp_rs {
    neighbor 195.66.224.1 as 8714;
    description "LINX LON1 RS1";
}

protocol bgp rs_linx_2 from tpl_ixp_rs {
    neighbor 195.66.224.2 as 8714;
    description "LINX LON1 RS2";
}

# Equinix Ashburn Route Server
protocol bgp rs_eqix_ash from tpl_ixp_rs {
    neighbor 206.126.236.1 as 19754;
    description "Equinix Ashburn RS";
}

# Equinix NYC Route Server
protocol bgp rs_eqix_nyc from tpl_ixp_rs {
    neighbor 198.32.124.1 as 19754;
    description "Equinix NYC RS";
}

#===============================================================================
# Bilateral Peering Sessions (Priority Peers)
#===============================================================================

# Cloudflare - bilateral at DE-CIX
# protocol bgp peer_cloudflare from tpl_bilateral {
#     neighbor 80.81.193.13 as 13335;
#     description "Cloudflare (bilateral)";
# }

# Google - bilateral at DE-CIX
# protocol bgp peer_google from tpl_bilateral {
#     neighbor 80.81.193.15 as 15169;
#     description "Google (bilateral)";
# }

# Facebook/Meta - bilateral
# protocol bgp peer_facebook from tpl_bilateral {
#     neighbor 80.81.193.32 as 32934;
#     description "Facebook/Meta (bilateral)";
# }

# Amazon - bilateral
# protocol bgp peer_amazon from tpl_bilateral {
#     neighbor 80.81.193.16 as 16509;
#     description "Amazon (bilateral)";
# }

# Microsoft - bilateral
# protocol bgp peer_microsoft from tpl_bilateral {
#     neighbor 80.81.193.8 as 8075;
#     description "Microsoft (bilateral)";
# }

#===============================================================================
# Transit Providers (Backup)
#===============================================================================

# Hurricane Electric Transit
# protocol bgp transit_he from tpl_transit {
#     neighbor 100.100.100.1 as 6939;
#     description "Hurricane Electric Transit";
#     password "SECRET";
# }

# Cogent Transit
# protocol bgp transit_cogent from tpl_transit {
#     neighbor 100.100.100.2 as 174;
#     description "Cogent Transit";
# }

#===============================================================================
# Include additional configurations
#===============================================================================

# Include per-IXP configurations
# include "/etc/bird/ixp/*.conf";

# Include customer configurations
# include "/etc/bird/customers/*.conf";

################################################################################
# End of Configuration
################################################################################
